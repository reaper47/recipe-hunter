package integrations_test

import (
	"fmt"
	"io"
	"mime/multipart"
	"net/http"
	"net/http/httptest"
	"regexp"
	"testing"
	"time"

	"github.com/google/go-cmp/cmp"
	"github.com/google/uuid"
	"github.com/reaper47/recipya/internal/integrations"
	"github.com/reaper47/recipya/internal/models"
)

func TestNextcloudImport(t *testing.T) {
	srv := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		url := r.URL.String()

		recipesRegex := regexp.MustCompile(`^/apps/cookbook/api/v1/recipes$`)
		if recipesRegex.MatchString(url) {
			payload := `[
			  {
				"recipe_id": 130,
				"name": "Best Chocolate Chip Cookies",
				"keywords": null,
				"category": "Dessert",
				"dateCreated": "2023-09-26 07:56:21",
				"dateModified": "2023-09-26 07:56:21",
				"imageUrl": "/apps/cookbook/webapp/recipes/130/image?size=thumb",
				"imagePlaceholderUrl": "/apps/cookbook/webapp/recipes/130/image?size=thumb16"
			  },
			  {
				"recipe_id": 140,
				"name": "Jesus Buds",
				"keywords": "chips,jesus",
				"category": "Breakfast",
				"dateCreated": "2023-09-27 13:42:51",
				"dateModified": "2023-09-27 13:42:51",
				"imageUrl": "/apps/cookbook/webapp/recipes/140/image?size=thumb",
				"imagePlaceholderUrl": "/apps/cookbook/webapp/recipes/140/image?size=thumb16"
			  }
			]`
			w.WriteHeader(http.StatusOK)
			_, _ = fmt.Fprint(w, payload)
			return
		}

		recipeInfoRegex := regexp.MustCompile(`^/apps/cookbook/api/v1/recipes/(\d+)$`)
		if recipeInfoRegex.MatchString(url) {
			var payload string
			id := recipeInfoRegex.FindStringSubmatch(url)[1]
			if id == "130" {
				payload = `{"@context":"https://schema.org","@type":"Recipe","headline":"Best Chocolate Chip Cookies","datePublished":"1998-04-18T16:10:32.000-04:00","dateModified":"2023-09-26T07:56:21+0000","author":[{"@type":"Person","name":"Dora"}],"description":"This chocolate chip cookie recipe makes delicious cookies with crisp edges and chewy middles. Try this wildly-popular cookie recipe for yourself!","image":"https://www.allrecipes.com/thmb/8xwaWAHtl_QLij6D-G0Z4B1HDVA=/1500x0/filters:no_upscale():max_bytes(150000):strip_icc()/10813-best-chocolate-chip-cookies-mfs-146-4x3-b108aceffa6043a1ac81c3c5a9b034c8.jpg","video":{"@type":"VideoObject","contentUrl":"https://content.jwplatform.com/videos/qHQSNVCK-K3AjnAEN.mp4","description":"When it comes to fresh and delicious cookies, nothing beats homemade. In this video, Nicole shows you how to make Allrecipes’s top rated recipe for chocolate chip cookies. Using a deliciously sweet cookie dough that’s beaten with brown sugar and vanilla, fold in mini chocolate chips. Once the dough has been chilled in the fridge, distribute it onto a baking sheet and bake for ten minutes in the oven. With a tender texture and a rich, buttery taste, they're the ultimate comfort snack!","duration":"PT3M33S","name":"How to Make the Best Chocolate Chip Cookies","thumbnailUrl":"https://cdn.jwplayer.com/v2/media/qHQSNVCK/poster.jpg?width=720","uploadDate":"2023-08-24T22:27:49.228-04:00"},"publisher":{"@type":"Organization","name":"Allrecipes","url":"https://www.allrecipes.com","logo":{"@type":"ImageObject","url":"https://www.allrecipes.com/thmb/Z9lwz1y0B5aX-cemPiTgpn5YB0k=/112x112/filters:no_upscale():max_bytes(150000):strip_icc()/allrecipes_logo_schema-867c69d2999b439a9eba923a445ccfe3.png","width":112,"height":112},"brand":"Allrecipes","publishingPrinciples":"https://www.allrecipes.com/about-us-6648102#toc-editorial-guidelines","sameAs":["https://www.facebook.com/allrecipes","https://www.instagram.com/allrecipes/","https://www.pinterest.com/allrecipes/","https://www.tiktok.com/@allrecipes","https://www.youtube.com/user/allrecipes/videos","https://twitter.com/Allrecipes","https://flipboard.com/@Allrecipes","https://en.wikipedia.org/wiki/Allrecipes.com","https://apps.apple.com/us/app/allrecipes-dinner-spinner/id299515267","https://play.google.com/store/apps/details?id=com.allrecipes.spinner.free&hl=en_US&gl=US","https://www.youtube.com/c/foodwishes","https://www.linkedin.com/company/19312/admin/"]},"name":"Best Chocolate Chip Cookies","aggregateRating":{"@type":"AggregateRating","ratingValue":"4.6","ratingCount":"18842"},"cookTime":null,"nutrition":{"@type":"NutritionInformation","calories":"146 kcal","carbohydrateContent":"19 g","cholesterolContent":"10 mg","fiberContent":"1 g","proteinContent":"2 g","saturatedFatContent":"4 g","sodiumContent":"76 mg","fatContent":"8 g","unsaturatedFatContent":"0 g"},"prepTime":null,"recipeCategory":"Dessert","recipeCuisine":["American"],"recipeIngredient":["1 cup butter, softened","1 cup white sugar","1 cup packed brown sugar","2 eggs","2 teaspoons vanilla extract","1 teaspoon baking soda","2 teaspoons hot water","0.5 teaspoon salt","3 cups all-purpose flour","2 cups semisweet chocolate chips","1 cup chopped walnuts"],"recipeInstructions":["Gather your ingredients, making sure your butter is softened, and your eggs are room temperature.","Preheat the oven to 350 degrees F (175 degrees C).","Beat butter, white sugar, and brown sugar with an electric mixer in a large bowl until smooth.","Beat in eggs, one at a time, then stir in vanilla.","Dissolve baking soda in hot water. Add to batter along with salt.","Stir in flour, chocolate chips, and walnuts.","Drop spoonfuls of dough 2 inches apart onto ungreased baking sheets.","Bake in the preheated oven until edges are nicely browned, about 10 minutes.","Cool on the baking sheets briefly before removing to a wire rack to cool completely.","Store in an airtight container or serve immediately and enjoy!"],"recipeYield":48,"totalTime":null,"review":[{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"1"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"This is the first recipe from this website that I've been disappointed with. I followed the recipe exactly and these cookies were very bland."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Hobby loved them. He requests them regularly."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"I’ve been trying to find the best cookie. Thought I found it the other day then came across this recipe. I only had one egg left so added a little more butter. Didn’t know if that would be ok but they came out Great. My sons love them. I’m gonna use this Recipe from now on. Thank you"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"randy mattox"},"reviewBody":"I’ve made this recipe on numerous occasions and they always turn out great!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Delicious! But to make them even more delicious, use extra vanilla and an additional pinch of salt to bring out the flavour. I also found that 10 minutes wasn’t enough time; my oven tends to run a little hot, but even then I baked them for 15.5 minutes to achieve the perfect “crunchy on the outside, gooey on the inside” texture. But this is a great recipe and I love the layout of the ingredients and measurements on the side of the instructions, it really saves the hassle of having to scroll up and down. 10/10 recommend!!!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"i added a little bit more vanilla."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Eboni "},"reviewBody":"Absolutely delicious. Make sure your butter is really soft. Easy to make."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Great recipe, I made them for my roomates and they loved them!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Cookin' Kristin"},"reviewBody":"Rich tasting batter"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"This turned out to be one of the best cookies I’ve ever made, 10/10 would recommend"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"debbie"},"reviewBody":"I love these cookies. I love that U can taste the richness of these cookies. I made them twice and I am going to make them again today. I had a hard time finding this recipe again"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Roz"},"reviewBody":"Awesome!! Followed recipe just as originally written!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"4"},"author":{"@type":"Person","name":"Marie"},"reviewBody":"I agree with others that there is too much flour in the recipe - making these too cakey. These would be better with at least half a cup less flour. I also pressed each dough mound down in the pan and baked them for 11 minutes."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"I was a cook for 12 years and I have to say this recipe is quite good.i decided that I wanted to make some cookies with my daughter and not knowing what ever happened to my recipe book ,I've always turned to this site,and I have to say these things are great.nice and soft in the middle.im not sure what others are doing wrong.i followed the recipe to a tee and they turned out great.5/5 would make again."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"2"},"author":{"@type":"Person","name":"Sunny_cheeba155"},"reviewBody":"I made these, they were doughy and bready, like a hot dog. Bad cookies, no snap."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Best recipe Ive ever tried so far. They turned out perfect 😍"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Jan Picerno"},"reviewBody":"easy and delicious!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"This is grandma's recipie!! I've been professionally cooking for many years and I'm telling you these are the best chocolate chip cookies in my opinion. Our coffee shop needed cookies for the glass case so when I made them I did a ×4 batch. The second time my preference was to add a dash more vanilla and a little more brown sugar to the same recipe. Even better. I made sure to add my wet ingredients together first, scramble the eggs well on the side then add them to wet ingredients, and then mix the rest of everything good. Convection oven 325 9 or 10 minutes. Perfect. Most tasty. We like dark bittersweet chips too. Thanks! Mmmm so good."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Ginger Gatling"},"reviewBody":"These are excellent!! They are now my go-to recipe for chocolate chip cookies!!!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"4"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Very nice cookies. I made them according to the instructions. Next time I will make them with at least 1/2 cup less flour. The amount of sugar is good. They are really sweet. They don't look like cookies. They are a bit dome looking. Still, crunchy on the outside, soft on the inside. Would recommend everyone to make, with slight adjustments"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"sodabear"},"reviewBody":"Followed exactly and they turned out perfect"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"3"},"author":{"@type":"Person","name":"Stacy Peay Jones"},"reviewBody":"These are not that good.. WAY TO MUCH FLOUR Even with all that flour they still turned out paper thin. Off to find another recipe"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Recipe worked perfectly, it was my first time making cookies without a mix and I had no trouble with it. If you make larger cookies like my family likes and like I made, be prepared for each batch to take longer; one pan of 6 largish cookies takes about 15/16 minutes instead of the recipe's 10 minutes, which I assume is designed to accommodate smaller cookies. Once I dialed in the time, it went perfectly. Photo is of the first batch."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Tammi"},"reviewBody":"My son said this was the best he had ever!!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"4"},"author":{"@type":"Person","name":"M. I."},"reviewBody":"These cookies were amazing!! they're so soft and perfectly sweet. This was the best cookie recipe I have ever eaten! I would honestly change nothing about this recipe considering it was a very good cookie. They turned out to be a lump/dome shape but that really didn't matter they tasted absolutely delicious! I didn't add any walnuts, because most people in my family don't like walnuts, but these were still great. Next time I will try them with walnuts and see if they are better that way. Thank you for this recipe!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"3"},"author":{"@type":"Person","name":"Chrispy Garner"},"reviewBody":"The batch would’ve been great but there was too much flour in the recipe this turning the cookies into more like a muffin."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"2"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Disappointing…I like the texture, but they taste like there’s too much flour."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Jade Rudic"},"reviewBody":"I did not add walnuts and used an extra half cup chocolate ship. Under cooked them a bit and they are amazing and not at all dry like some people mentioned."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"1"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Dry asf please dont follow the recipe"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"olddogsneedlovetoo"},"reviewBody":"This is my favorite favorite favorite favorite chocolate chip cookie recipe because it's all made in one bowl, it makes enough dough that you can save some to make fresh for the next few days, the finished cookies stay in a ball if you make them that way (they don't spread thin, they stay big and thick), they only need 10 minutes of cook time, they don't skimp on the chocolate chips, and most importantly, they are super delicious!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Onnie Bates"},"reviewBody":"my grandkids make this , measurements are easy for them to follow. We use all brown sugar and the cookies are the best"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Julie"},"reviewBody":"This is my go-to recipe. 1st chocolate chip cookie recipe I’ve made that my husband actually liked. I use mini semisweet chocolate chips, no walnuts. They are just soft enough and the taste is spot on! I usually make just 1/2 the recipe as 4 dozen cookies is a lot!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Simple recipe and the results are perfect. I always get compliments when I make them that they are the best Chocolate ship cookies!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"I almost never bake (i.e. I'm an amateur) and these turned out amazing!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"3"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Not the best but not the worst."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Jill Johnson"},"reviewBody":"This is THE best chocolate chip cookie. Please follow every direction, especially the baking soda in hot water. Do not reduce the brown sugar amount, this prevents the cookies from spreading too thin. People who deviate from the recipe should not give negative comments."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"I made them and they were soo good! I put the dough in the fridge between batches cooking, this’ll help when you are scooping the cookies out. Also since I’m using a small round ice cream scooper I cooked the cookies for 12-15 minutes."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Loved this. My fiancé ate six cookies before the other two batches were done. Followed recipe to the T Chewy, gooey, delicious"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"3"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Lol. I really don’t even know how to rate these."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"4"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Maybe less flour? Definitely let it set in fridge"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"exlirbookd"},"reviewBody":"These cookies are amazing! Definitely would recommend! Instead of 2 cups of chocolate chips and 1 cup of walnuts, I just used 2 cups of chocolate chips. Tip: When placing the cookie dough on the baking sheet, I used the back of the scoop to help them spread more. (:"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Dale Skeen"},"reviewBody":"Easy, simple but delicious cookie recipe!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"This a great, easy recipe! These are chewier chocolate chip cookies, which are my favorite!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"2"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"This recipe is not good someone needs to say it. Just use the tollhouse recipe! :)"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Donna Kay Bloom Hipfner"},"reviewBody":"They are very good cookies I did use a fourth a cup less sugar I don't like as much sugar. I dropped a tsp of the cookie to cookie sheet. And I cooked it at 375 for 14 minutes reason being is cuz I have the black cookie sheets and it just Cooks better"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"These cookies are delicious. I have made them twice now and perfect both times. I followed the recipe as written. I saw where some reviews that found them dry. You don’t want to over bake them. I did bake mine for 12 minutes instead of 10. Be careful not to over bake. So far mine have been great."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"It was an overall delicious cookie, with crispy outsides and chewy insides. My family and I substituted some dried cherries for the walnuts, and substituted about 1/3 of the flour for oats. Note: add more than 1/3 of the flour for oats. We also used half semi-sweet chocolate chips and half semi-sweet chopped chocolate chunks. Very tasty, definitely recommend."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Hailey Hans"},"reviewBody":"I added a little extra salt because you can't go wrong with salty chocolate chip cookies! I had to space mine out a lot because the batter ran. They had to be baked for a lot longer than stated and I used a lot less chocolate chips and there were still a lot! Besides a few tweaks, these are by far the best chocolate chip cookies I have ever made!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"I’m 36 and have been baking since childhood, and this is hands-down the best chocolate chip cookie recipe I have ever made! Don’t skip the nuts, they really add something. I use about 1.5 cups of mini chocolate chips, and bake for 12-13 minutes per batch. I think my spoonfuls might be slightly larger, or else my oven is slower. This will be my go-to recipe forever!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Aisha Jackson"},"reviewBody":"This is my go to recipe for cookies. The only difference I add a table spoon of espresso and add the baking soda to it. To Amp up the chocolate flavor 😋"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"2"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Taste okay, followed recipe exactly but had to keep cookies in for over 20 mins bc they were nowhere close to done at 10 mins. 2 1/2 cups flour may be better"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"These cookies were so good and perfect for when you are craving sweets!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"1"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Honestly, hated it. I followed the recipe exactly and found that they didn’t spread well and there is waaay too many chocolate chips. They just didn’t taste great either."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Loved it. Awesome recipe!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Great but I had to add a little milk as it was too dry"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"demented"},"reviewBody":"Make these cookies as recipe calls for and baked them in a dish to make cookie bars. Best cookies ever, didn't last long so I will make again soon. This is now my go to cookie recipe."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"LiSaGsilly"},"reviewBody":"I always get asked for the recipe! They really are the best cookies."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"These cookies are beyond amazing 🤩 This recipe is the most exquisite and stupendous thing to come upon my taste buds. We really enjoyed this cookies but we had a little mishap. So we only decided to add 1.5 cups of flour and theh turned out much better. Take a peak!!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"BEST EVER they are crispy on the out side chewed on the inside they are amazing"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"2"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"They did not turn out to be 5 stars. This took way longer than expected and turned out clumpy and didn’t spread across the pan very well. They were pretty good but didn’t reach 5 stars! ;)"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Stardust "},"reviewBody":"This is my favorite chocolate chip cookies recipe! Crisp on the outside, soft in the middle, and the chocolate chips actually melt! Everyone I've shared them with likes them too :)"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Perfectly chewy on the inside and crisp on the outside with just the right amount of chocolate chips! 😊"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"4"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"I mixed up h half a batch. It is tasty. They didn't spread out as much as I expected, however I did sub whole wheat white flour, Splenda baking sugar, and Splenda brown sugar.. My problem was with the organization of the directions. It was more haphazard than most I use online. The recipe seemed to be in 2 repeated parts. Hard to explain."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"These are my favorite. Been making them for the last 5 years. People always ask which recipe it is. Not sure why people are giving them a bad review."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"1"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"I don't understand these 5-star ratings, or anything close to 5 stars. If I could give it less than one star, I would. These were horrible. They were dry as the desert and tasteless (I even added extra vanilla). I followed the recipe to a \"T.\" I leveled off the flour, so there was no additional/extra flour added. I also cooked them at a lower temperature and tried less time on the 2nd batch. They had more of a cakey/muffin-top recipe. I do not recommend making this recipe."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Anne Nguyen-Do"},"reviewBody":"Very good! I added half white chocolate and half milk chocolate with walnuts. Yum!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Texture and flavor are a 10/10 crispy on the outside and chewy on the inside. This is a perfect recipe if you don't want to spend a lot of money and time. Super easy to make and delicious"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"3"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Too much flour in recipe prevents the cookies from adequately \"spreading out\" while baking, and diminishes the buttery sugary goodness found in other recipes..."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Mari Craig"},"reviewBody":"These cookies are amazing. Here is the metric version of the ingredients list, which is what I use: 225g butter, softened 200g caster sugar 225g dark brown soft sugar 2 medium eggs 2 tsp vanilla essence 1 tsp bicarbonate of soda 2 tsp hot water 1/2 teaspoon salt 375g plain flour 350g dark chocolate chips 125g chopped walnuts I usually get 50 cookies out of that, and I usually only use chocolate chips - haven't made it with the walnuts yet, maybe one day I'll try :)"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"4"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"I think they taste too much like butter. Texture and look are a 100000/10 . What happens if I brown the butter???? You think it will alter the recipe in terms of measurement??"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"4"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Original recipe was too sweet. Doubled recipe but not the sugar and was great. Came out kinda between a cookie and a scone. Delicious!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"4"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"We were out of chocolate chips so I used 1 cup of butterscotch chips and 1 cup of toffee chips, and everyone loved them"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Im pretty sure you don’t need another cookie recipe. This is literally the best!!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Perfect cookie....loved it"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"I added marshmallows, white and milk choc chips, and used almonds instead of walnuts and a touch of cinnamon. Love this easy recipe!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Christine Wright"},"reviewBody":"My mom had the most perfect chocolate chip cookies recipe when I was growing up (70's) that she got from a friend and she titled it \"Jesse's Chocolate Chip Cookies\". We never in my memory ever used another recipe and there was always a container of homemade cookies on our counter. This recipe is so very close to that recipe! Which is a relief for me because I went through a house fire and lost my mother's recipe card so stumbling upon this recipe was a thrill ... The only addition to this recipe I personally use is 1/4 t. Cream of Tartar, and of course I skip the water part - I just add the baking soda normally with the salt after creaming the butter, sugars and eggs. I've been making homemade cookies for about 45 years now, and for new bakers there's a couple things you need to know. First is the fat content in your butter. As time goes by it gets more difficult to find real butter with a high enough fat content to make desserts. Fat content is so important to the best quality end product, and throughout my life I've seen one butter brand after the other become barely useable for true high quality baking as water content increases. I don't know if I can say the brand I'm currently using, but it's Irish butter and it does an excellent job in baking desserts and is readily accessible in the US. Also - temperature is very very important. Your eggs need to be room temperature but not warm. In my house that takes 15-20 minutes tops. Butter needs to be softened but not overly so. In my house it takes 1 hour, anything more than that and it needs placed in the refrigerator again. And last but not least, the size of your cookies will affect your baking time. 8 minutes cooking time is a guide, but depending on the size of your cookies it could be anywhere from 7 minutes to 12 minutes a tray. I am partial to the 12 minutes size myself... Lol. Thanks for such an awesome recipe... :) My cookies come out perfect every time with these!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"this is my go to recipe, I make them as written - perfect chocolate chip cookies every time. Use real ingredients - butter and vanilla. Make sure your butter and eggs are room temperature. Don't overbeat when adding the flour - use lowest speed or stir in by hand. For those saying too much flour - how are you measuring it out? Flour should always be spooned into the measuring cup and leveled, not scooped out using the measuring cup. Doing that packs down the flour so you end up adding too much flour to your recipe."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Marie Kennison"},"reviewBody":"Baked these by the recipe and they came out delicious. Great basic recipe. I've made a second time. When making cookies, beat the butter for a long time, add sugar and beat some more for a total of 8-10 minutes. Add eggs and beat a couple minutes more. Measure flour by gently spooning into cup and level with a butter knife. Only mix flour a little, just until it's all mixed in. Gently mix in chocolate chips and nuts."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"4"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"I loved it, it tasts so good, but it is hard to get out of the tray and crumbles to much"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"1"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"These are far from the best. These cookies were dry and I needed to add more sugar and flour so the dough wasn't so sticky. 👎 👎 👎"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"3"},"author":{"@type":"Person","name":"Kiss523"},"reviewBody":"They were yummy…. Just not the best."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"2"},"author":{"@type":"Person","name":"Laura"},"reviewBody":"Too much flour"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Shatoia"},"reviewBody":"I literally just made these and they are perfect. I love them. will be keeping this recipe for ever."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Big hit at my house although I’m being told too put less chocolate chips in the recipe."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"movard"},"reviewBody":"I've been a baker my whole life and have never found a chocolate chip cookie recipe that I LOVE. Well, this is it!! This recipe is amazing!! I made it just as written and everyone in my family is blown away - even my neighbors. I give this recipe to people that ask and they agree - it's the best! Stop here and make this recipe. Make all those people in your life happy with some cookies."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"It's was our first time from scratch and we are absolutely happy with the result."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Followed recipe mostly, made some adjustments. •Substituted flour with gluten free flour • Swapped the last half cup of flour for a half cup of dark hersheys cocoa powder •Instead of two cups normal chocolate chips, used 1 cup of mini chips and one cup of normal sized chips •Bake time adjusted to 13-15 minutes instead of 10. The cookies turned out wonderful, many compliments by my friends. Hope this help some!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"2"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Thumbs down Made these with my 6 yr old granddaughter and they were way too dry. Tried to salvage them and won’t use this recipe again"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Delia"},"reviewBody":"I must not know much about cookies because they are good to me, but to everyone else who has tried this cookie, it's THE BEST COOKIE EVER. Even my coworker's son, who is PICKY and doesn't like nuts absolutely loved this recipe. I have received orders for this cookie so that alone says a lot. I do enjoy this cookie recipe but I guess I don't appreciate it as much as true cookie lovers ;)"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"3"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"disappointing...too much flour. i'll stick to King Arthur recipe."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Awesome cookies, super easy to make!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"These are the best cookies ever. I have tried countless recipes to find the perfect cookie, and this is the one! It's the best especially out fresh. Thank you!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"I found out quite by accident ( brown sugar got as hard as a brick) that if you take brown sugar put it into a blender and pulse it really fine like powdered sugar. It makes a better tasting cookie. Not as grainy with all the sugar crystals."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Added a cup of crushed mixed nuts, could've added 2. Used a 3/4c of sugar., 3/4c of chocolate chips. Baked for 16 mins, not the 10 mins suggested in the recipe. Chilled the dough, for less spread."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Anna M Courter"},"reviewBody":"Some of the best chocolate chip cookies I've ever made! Keep in mind they won't \"fall\" as much as normal. So you might want to flatten the balls of dough a little bit."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"I make it exactly as it is. I scoop the flour out by a large spoon so it's not too compacted so the 3 cups of flour works well for me. My husband is fussy and he LOVES these! ( I'm celiac so have I not tasted myself!)."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Allrecipes Member"},"reviewBody":"Sooo good. I changed some things up just cause I didn’t have all ingredients for example half unsalted butter half salted butter, using less flour, and only light brown sugar but this turned out insanely incredible."},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"Maribeth Grywalski"},"reviewBody":"Delicious cookie! Everyone loved them!"},{"@type":"Review","reviewRating":{"@type":"Rating","ratingValue":"5"},"author":{"@type":"Person","name":"KC Daddio"},"reviewBody":"Hard to go wrong with chocolate chip cookies but these turned out great!"}],"mainEntityOfPage":{"@type":["WebPage"],"@id":"https://www.allrecipes.com/recipe/10813/best-chocolate-chip-cookies/","breadcrumb":{"@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https://www.allrecipes.com/recipes/362/desserts/cookies/","name":"Cookies"}},{"@type":"ListItem","position":2,"item":{"@id":"https://www.allrecipes.com/recipes/839/desserts/cookies/chocolate-chip-cookies/","name":"Chocolate Chip Cookie Recipes"}},{"@type":"ListItem","position":3,"item":{"@id":"https://www.allrecipes.com/recipe/10813/best-chocolate-chip-cookies/","name":"Best Chocolate Chip Cookies"}}]},"reviewedBy":[{"@type":"Person","name":"Allrecipes Test Kitchen","url":"https://www.allrecipes.com/allrecipes-test-kitchen-7553892"}]},"about":[],"id":"130","keywords":"","tool":[],"url":"https://www.allrecipes.com/recipe/10813/best-chocolate-chip-cookies/","dateCreated":"2023-09-26T07:56:21+0000","printImage":true,"imageUrl":"/apps/cookbook/webapp/recipes/130/image?size=full"}`
			} else {
				payload = `{"id":"140","name":"Jesus Buds","description":"The best recipes approved by Jesus","url":"","image":"/Nextcloud.png","prepTime":"PT2H15M0S","cookTime":"PT1H30M0S","totalTime":"PT3H45M0S","recipeCategory":"Breakfast","keywords":"chips,jesus","recipeYield":12,"tool":[],"recipeIngredient":["1 apple","2 cups chocolate","1 cup flour"],"recipeInstructions":["Mix everything in a big bowl","Preheat oven at 350 f","Put mixture in an oven bowl","Put in oven and pray to jesus the cookies don't burn after 15 minutes"],"nutrition":{"servingSize":"1","proteinContent":"2 g","sugarContent":"50g","calories":"450kcal","@type":"NutritionInformation"},"@context":"https://schema.org","@type":"Recipe","dateModified":"2023-09-27T13:42:51+0000","dateCreated":"2023-09-27T13:42:51+0000","printImage":true,"imageUrl":"/apps/cookbook/webapp/recipes/140/image?size=full"}`
			}
			w.WriteHeader(http.StatusOK)
			_, _ = fmt.Fprint(w, payload)
			return
		}

		recipeImageRegex := regexp.MustCompile(`^/apps/cookbook/webapp/recipes/(\d+)/image`)
		if recipeImageRegex.MatchString(url) {
			fmt.Println("image")
			return
		}
	}))
	defer srv.Close()
	files := &mockFiles{}

	c := make(chan models.Progress)
	var (
		got models.Recipes
		err error
	)
	go func() {
		defer close(c)
		got, err = integrations.NextcloudImport(srv.URL, "master", "yoda", files.UploadImage, c)
		if err != nil {
			return
		}
	}()
	for range c {
	}

	t1, _ := time.Parse("2006-01-02 15:04:05 +0000 UTC", "2023-09-26 00:00:00 +0000 UTC")
	createdAt1, _ := time.Parse("2006-01-02 15:04:05 +0000 UTC", "1998-04-18 00:00:00 +0000 UTC")
	t2, _ := time.Parse("2006-01-02 15:04:05 +0000 UTC", "2023-09-27 00:00:00 +0000 UTC")
	img, _ := uuid.Parse("f2f4b3aa-1e04-42a2-a581-607bf84f6800")
	times, _ := models.NewTimes("PT2H15M", "PT1H30M")

	want := models.Recipes{
		models.Recipe{
			Category:    "dessert",
			CreatedAt:   createdAt1,
			Cuisine:     "American",
			Description: "This chocolate chip cookie recipe makes delicious cookies with crisp edges and chewy middles. Try this wildly-popular cookie recipe for yourself!",
			Images:      []uuid.UUID{img},
			Ingredients: []string{
				"1 cup butter, softened", "1 cup white sugar", "1 cup packed brown sugar",
				"2 eggs", "2 teaspoons vanilla extract", "1 teaspoon baking soda",
				"2 teaspoons hot water", "0.5 teaspoon salt", "3 cups all-purpose flour",
				"2 cups semisweet chocolate chips",
				"1 cup chopped walnuts",
			},
			Instructions: []string{
				"Gather your ingredients, making sure your butter is softened, and your eggs are room temperature.",
				"Preheat the oven to 350 degrees F (175 degrees C).",
				"Beat butter, white sugar, and brown sugar with an electric mixer in a large bowl until smooth.",
				"Beat in eggs, one at a time, then stir in vanilla.",
				"Dissolve baking soda in hot water. Add to batter along with salt.",
				"Stir in flour, chocolate chips, and walnuts.",
				"Drop spoonfuls of dough 2 inches apart onto ungreased baking sheets.",
				"Bake in the preheated oven until edges are nicely browned, about 10 minutes.",
				"Cool on the baking sheets briefly before removing to a wire rack to cool completely.",
				"Store in an airtight container or serve immediately and enjoy!",
			},
			Keywords: []string{""},
			Name:     "Best Chocolate Chip Cookies",
			Nutrition: models.Nutrition{
				Calories:           "146",
				Cholesterol:        "10",
				Fiber:              "1",
				Protein:            "2",
				SaturatedFat:       "4",
				Sodium:             "76",
				TotalCarbohydrates: "19",
				TotalFat:           "8",
				UnsaturatedFat:     "0",
			},
			UpdatedAt: t1,
			URL:       "https://www.allrecipes.com/recipe/10813/best-chocolate-chip-cookies/",
			Videos: []models.VideoObject{
				{
					AtType:       "VideoObject",
					ContentURL:   "https://content.jwplatform.com/videos/qHQSNVCK-K3AjnAEN.mp4",
					Description:  "When it comes to fresh and delicious cookies, nothing beats homemade. In this video, Nicole shows you how to make Allrecipes’s top rated recipe for chocolate chip cookies. Using a deliciously sweet cookie dough that’s beaten with brown sugar and vanilla, fold in mini chocolate chips. Once the dough has been chilled in the fridge, distribute it onto a baking sheet and bake for ten minutes in the oven. With a tender texture and a rich, buttery taste, they're the ultimate comfort snack!",
					Duration:     "PT3M33S",
					Name:         "How to Make the Best Chocolate Chip Cookies",
					ThumbnailURL: &models.ThumbnailURL{Value: "https://cdn.jwplayer.com/v2/media/qHQSNVCK/poster.jpg?width=720"},
					UploadDate:   time.Date(2023, 8, 24, 22, 27, 49, 0, time.FixedZone("-4", -4*60*60)),
				},
			},
			Yield: 48,
		},
		models.Recipe{
			Category:    "breakfast",
			CreatedAt:   t2,
			Description: "The best recipes approved by Jesus",
			Images:      []uuid.UUID{img},
			Ingredients: []string{"1 apple", "2 cups chocolate", "1 cup flour"},
			Instructions: []string{
				"Mix everything in a big bowl", "Preheat oven at 350 f",
				"Put mixture in an oven bowl",
				"Put in oven and pray to jesus the cookies don't burn after 15 minutes",
			},
			Keywords: []string{"chips", "jesus"},
			Name:     "Jesus Buds",
			Nutrition: models.Nutrition{
				Calories:     "450",
				IsPerServing: true,
				Protein:      "2",
				Sugars:       "50",
			},
			Times:     times,
			UpdatedAt: t2,
			Yield:     12,
		},
	}
	assertRecipes(t, got, want, files)
}

func assertRecipes(tb testing.TB, got, want models.Recipes, files *mockFiles) {
	tb.Helper()
	if files.uploadImageHitCount != len(want) {
		tb.Fatalf("got %d but want %d upload image hits", files.uploadImageHitCount, len(want))
	}
	if !cmp.Equal(got, want) {
		tb.Log(cmp.Diff(got, want))
		tb.Fail()
	}
}

type mockFiles struct {
	uploadImageHitCount int
}

func (m *mockFiles) ExportRecipes(_ models.Recipes, _ models.FileType) (string, error) {
	return "", nil
}

func (m *mockFiles) ExtractRecipes(_ []*multipart.FileHeader) models.Recipes {
	return models.Recipes{}
}

func (m *mockFiles) ReadTempFile(name string) ([]byte, error) {
	return []byte(name), nil
}

func (m *mockFiles) UploadImage(_ io.ReadCloser) (uuid.UUID, error) {
	m.uploadImageHitCount++
	return uuid.Parse("f2f4b3aa-1e04-42a2-a581-607bf84f6800")
}
